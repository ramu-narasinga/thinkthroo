{
  "title": "queueMacroTask in React source code\r",
  "published": false,
  "featured": false,
  "component": false,
  "toc": true,
  "body": {
    "raw": "\r\nIn this article, we analyze queueMacroTask in [React source code](https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/shared/enqueueTask.js).\r\n\r\n![](https://miro.medium.com/v2/resize:fit:875/1*-UpgzB4PpLH6s5_zxrA5Ng.png)\r\n\r\nAlthough, file and function are named as enqueueTask, it is imported as queueMacroTask. Unlike window.queueMicroTask, there is no function such as window.queueMarcoTask. setTimeout is an example of MacroTask.\r\n\r\nRead more about [event loop, micro task and macro task](https://javascript.info/event-loop).\r\n\r\n# **React’s enqueueTask:**\r\n\r\n```plaintext\r\n/**\r\n * Copyright © Meta Platforms, Inc. and affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n *\r\n * @flow\r\n */\r\nlet didWarnAboutMessageChannel = false;\r\nlet enqueueTaskImpl = null;\r\nexport default function enqueueTask(task: () => void): void {\r\n   if (enqueueTaskImpl === null) {\r\n     try {\r\n       // read require off the module object to get around the bundlers.\r\n       // we don't want them to detect a require and bundle a Node polyfill.\r\n       const requireString = ('require' + Math.random()).slice(0, 7);\r\n       // $FlowFixMe[invalid-computed-prop]\r\n       const nodeRequire = module && module[requireString];\r\n       // assuming we're in node, let's try to get node's\r\n       // version of setImmediate, bypassing fake timers if any.\r\n       enqueueTaskImpl = nodeRequire.call(module, 'timers').setImmediate;\r\n       } catch (_err) {\r\n       // we're in a browser\r\n       // we can't use regular timers because they may still be faked\r\n       // so we try MessageChannel+postMessage instead\r\n       enqueueTaskImpl = function (callback: () => void) {\r\n       if (__DEV__) {\r\n         if (didWarnAboutMessageChannel === false) {\r\n           didWarnAboutMessageChannel = true;\r\n           if (typeof MessageChannel === 'undefined') {\r\n             console.error(\r\n             'This browser does not have a MessageChannel implementation, ' +\r\n             'so enqueuing tasks via await act(async () => …) will fail. ' +\r\n             'Please file an issue at https://github.com/facebook/react/issues ' +\r\n             'if you encounter this warning.',\r\n             );\r\n           }\r\n         }\r\n       }\r\n       const channel = new MessageChannel();\r\n       channel.port1.onmessage = callback;\r\n       channel.port2.postMessage(undefined);\r\n     };\r\n   }\r\n  }\r\n  return enqueueTaskImpl(task);\r\n}\r\n```\r\n\r\nThis code has comments explaining what it does. There are some tricks we could learn here:\r\n\r\n* How to get around bundlers when you are writing your own enqueque trask.\r\n    \r\n* In node env, setImmediate can be used as MacroTask.\r\n    \r\n* In browser env, MessageChannel can be used to create a queueMacroTask effect.\r\n    \r\n\r\nThis enquequeTask is imported as MacroTask in ReactAct.js and is used as a fallback in case window.queueMicroTask does not exist:\r\n\r\n![](https://miro.medium.com/v2/resize:fit:875/1*5LrG6mdpwrJwfUGHl31q4Q.png)\r\n\r\nAt the following lines:\r\n\r\n* [https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L196](https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L196)\r\n    \r\n* [https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L121](https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L121)\r\n    \r\n# **About me:**\r\n\r\nHey, my name is Ramu Narasinga. I study large open-source projects and create content about their codebase architecture and best practices, sharing it through articles, videos.\r\n\r\nI am open to work on interesting projects. Send me an email at ramu.narasinga@gmail.com\r\n\r\nMy Github — [https://github.com/ramu-narasinga](https://github.com/ramu-narasinga)\r\n\r\nMy website — [https://ramunarasinga.com](https://ramunarasinga.com/)\r\n\r\nMy Youtube channel — [https://www.youtube.com/@thinkthroo](https://www.youtube.com/@thinkthroo)\r\n\r\nLearning platform — [https://thinkthroo.com](https://thinkthroo.com/)\r\n\r\nCodebase Architecture — [https://app.thinkthroo.com/architecture](https://app.thinkthroo.com/architecture)\r\n\r\nBest practices — [https://app.thinkthroo.com/best-practices](https://app.thinkthroo.com/best-practices)\r\n\r\nProduction-grade projects — [https://app.thinkthroo.com/production-grade-projects](https://app.thinkthroo.com/production-grade-projects)\r\n\r\n# **References**\r\n\r\n* [https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L366](https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L366)\r\n    \r\n* [https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/shared/enqueueTask.js](https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/shared/enqueueTask.js)  \r\n    3\\. [https://javascript.info/event-loop](https://javascript.info/event-loop)\r\n    \r\n\r\n[  \r\n](https://medium.com/tag/javascript?source=post_page-----88a6e0f39ee1--------------------------------)\r\n",
    "code": "var Component=(()=>{var p=Object.create;var i=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var b=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty;var g=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports),k=(a,e)=>{for(var s in e)i(a,s,{get:e[s],enumerable:!0})},l=(a,e,s,r)=>{if(e&&typeof e==\"object\"||typeof e==\"function\")for(let c of m(e))!f.call(a,c)&&c!==s&&i(a,c,{get:()=>e[c],enumerable:!(r=u(e,c))||r.enumerable});return a};var N=(a,e,s)=>(s=a!=null?p(b(a)):{},l(e||!a||!a.__esModule?i(s,\"default\",{value:a,enumerable:!0}):s,a)),w=a=>l(i({},\"__esModule\",{value:!0}),a);var d=g((y,t)=>{t.exports=_jsx_runtime});var M={};k(M,{default:()=>o,frontmatter:()=>q});var n=N(d()),q={title:\"queueMacroTask in React source code\"};function h(a){let e={a:\"a\",br:\"br\",code:\"code\",div:\"div\",h1:\"h1\",img:\"img\",li:\"li\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",ul:\"ul\",...a.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.p,{children:[\"In this article, we analyze queueMacroTask in \",(0,n.jsx)(e.a,{href:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/shared/enqueueTask.js\",children:\"React source code\"}),\".\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"https://miro.medium.com/v2/resize:fit:875/1*-UpgzB4PpLH6s5_zxrA5Ng.png\",alt:\"\"})}),`\n`,(0,n.jsx)(e.p,{children:\"Although, file and function are named as enqueueTask, it is imported as queueMacroTask. Unlike window.queueMicroTask, there is no function such as window.queueMarcoTask. setTimeout is an example of MacroTask.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"Read more about \",(0,n.jsx)(e.a,{href:\"https://javascript.info/event-loop\",children:\"event loop, micro task and macro task\"}),\".\"]}),`\n`,(0,n.jsx)(e.h1,{id:\"reacts-enqueuetask\",children:(0,n.jsx)(e.strong,{children:\"React\\u2019s enqueueTask:\"})}),`\n`,(0,n.jsx)(e.div,{\"data-rehype-pretty-code-fragment\":\"\",children:(0,n.jsx)(e.pre,{\"data-language\":\"plaintext\",\"data-theme\":\"default\",children:(0,n.jsxs)(e.code,{\"data-language\":\"plaintext\",\"data-theme\":\"default\",children:[(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"/**\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\" * Copyright \\xA9 Meta Platforms, Inc. and affiliates.\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\" *\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\" * This source code is licensed under the MIT license found in the\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\" * LICENSE file in the root directory of this source tree.\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\" *\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\" * @flow\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\" */\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"let didWarnAboutMessageChannel = false;\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"let enqueueTaskImpl = null;\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"export default function enqueueTask(task: () => void): void {\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"   if (enqueueTaskImpl === null) {\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"     try {\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       // read require off the module object to get around the bundlers.\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       // we don't want them to detect a require and bundle a Node polyfill.\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       const requireString = ('require' + Math.random()).slice(0, 7);\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       // $FlowFixMe[invalid-computed-prop]\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       const nodeRequire = module && module[requireString];\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       // assuming we're in node, let's try to get node's\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       // version of setImmediate, bypassing fake timers if any.\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       enqueueTaskImpl = nodeRequire.call(module, 'timers').setImmediate;\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       } catch (_err) {\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       // we're in a browser\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       // we can't use regular timers because they may still be faked\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       // so we try MessageChannel+postMessage instead\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       enqueueTaskImpl = function (callback: () => void) {\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       if (__DEV__) {\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"         if (didWarnAboutMessageChannel === false) {\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"           didWarnAboutMessageChannel = true;\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"           if (typeof MessageChannel === 'undefined') {\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"             console.error(\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"             'This browser does not have a MessageChannel implementation, ' +\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"             'so enqueuing tasks via await act(async () => \\u2026) will fail. ' +\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"             'Please file an issue at https://github.com/facebook/react/issues ' +\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"             'if you encounter this warning.',\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"             );\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"           }\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"         }\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       }\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       const channel = new MessageChannel();\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       channel.port1.onmessage = callback;\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"       channel.port2.postMessage(undefined);\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"     };\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"   }\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"  }\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"  return enqueueTaskImpl(task);\"})}),`\n`,(0,n.jsx)(e.span,{className:\"line\",children:(0,n.jsx)(e.span,{children:\"}\"})})]})})}),`\n`,(0,n.jsx)(e.p,{children:\"This code has comments explaining what it does. There are some tricks we could learn here:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:\"How to get around bundlers when you are writing your own enqueque trask.\"}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:\"In node env, setImmediate can be used as MacroTask.\"}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:\"In browser env, MessageChannel can be used to create a queueMacroTask effect.\"}),`\n`]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"This enquequeTask is imported as MacroTask in ReactAct.js and is used as a fallback in case window.queueMicroTask does not exist:\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"https://miro.medium.com/v2/resize:fit:875/1*5LrG6mdpwrJwfUGHl31q4Q.png\",alt:\"\"})}),`\n`,(0,n.jsx)(e.p,{children:\"At the following lines:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.a,{href:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L196\",children:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L196\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.a,{href:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L121\",children:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L121\"})}),`\n`]}),`\n`]}),`\n`,(0,n.jsx)(e.h1,{id:\"about-me\",children:(0,n.jsx)(e.strong,{children:\"About me:\"})}),`\n`,(0,n.jsx)(e.p,{children:\"Hey, my name is Ramu Narasinga. I study large open-source projects and create content about their codebase architecture and best practices, sharing it through articles, videos.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"I am open to work on interesting projects. Send me an email at \",(0,n.jsx)(e.a,{href:\"mailto:ramu.narasinga@gmail.com\",children:\"ramu.narasinga@gmail.com\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"My Github \\u2014 \",(0,n.jsx)(e.a,{href:\"https://github.com/ramu-narasinga\",children:\"https://github.com/ramu-narasinga\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"My website \\u2014 \",(0,n.jsx)(e.a,{href:\"https://ramunarasinga.com/\",children:\"https://ramunarasinga.com\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"My Youtube channel \\u2014 \",(0,n.jsx)(e.a,{href:\"https://www.youtube.com/@thinkthroo\",children:\"https://www.youtube.com/@thinkthroo\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Learning platform \\u2014 \",(0,n.jsx)(e.a,{href:\"https://thinkthroo.com/\",children:\"https://thinkthroo.com\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Codebase Architecture \\u2014 \",(0,n.jsx)(e.a,{href:\"https://app.thinkthroo.com/architecture\",children:\"https://app.thinkthroo.com/architecture\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Best practices \\u2014 \",(0,n.jsx)(e.a,{href:\"https://app.thinkthroo.com/best-practices\",children:\"https://app.thinkthroo.com/best-practices\"})]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Production-grade projects \\u2014 \",(0,n.jsx)(e.a,{href:\"https://app.thinkthroo.com/production-grade-projects\",children:\"https://app.thinkthroo.com/production-grade-projects\"})]}),`\n`,(0,n.jsx)(e.h1,{id:\"references\",children:(0,n.jsx)(e.strong,{children:\"References\"})}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.a,{href:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L366\",children:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/react/src/ReactAct.js#L366\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.li,{children:[`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.a,{href:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/shared/enqueueTask.js\",children:\"https://github.com/facebook/react/blob/5d19e1c8d1a6c0b5cd7532d43b707191eaf105b7/packages/shared/enqueueTask.js\"}),(0,n.jsx)(e.br,{}),`\n`,\"3. \",(0,n.jsx)(e.a,{href:\"https://javascript.info/event-loop\",children:\"https://javascript.info/event-loop\"})]}),`\n`]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsxs)(e.a,{href:\"https://medium.com/tag/javascript?source=post_page-----88a6e0f39ee1--------------------------------\",children:[(0,n.jsx)(e.br,{}),`\n`]})})]})}function o(a={}){let{wrapper:e}=a.components||{};return e?(0,n.jsx)(e,{...a,children:(0,n.jsx)(h,{...a})}):h(a)}return w(M);})();\n;return Component;"
  },
  "_id": "blog/queueMacroTask-in-React-source.mdx",
  "_raw": {
    "sourceFilePath": "blog/queueMacroTask-in-React-source.mdx",
    "sourceFileName": "queueMacroTask-in-React-source.mdx",
    "sourceFileDir": "blog",
    "contentType": "mdx",
    "flattenedPath": "blog/queueMacroTask-in-React-source"
  },
  "type": "Doc",
  "slug": "/blog/queueMacroTask-in-React-source",
  "slugAsParams": "queueMacroTask-in-React-source"
}